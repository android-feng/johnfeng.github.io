<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Android | John Feng's Blog]]></title>
  <link href="http://johnfeng.github.io/blog/categories/android/atom.xml" rel="self"/>
  <link href="http://johnfeng.github.io/"/>
  <updated>2015-02-27T12:52:53+08:00</updated>
  <id>http://johnfeng.github.io/</id>
  <author>
    <name><![CDATA[Guangwei Feng]]></name>
    <email><![CDATA[fengguangwei.007@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Android WebView Issue - Service Not Registered: android.speech.tts.TextToSpeech]]></title>
    <link href="http://johnfeng.github.io/blog/2015/02/27/android-webview-issue-service-not-registered-android-dot-speech-dot-tts-dot-texttospeech/"/>
    <updated>2015-02-27T12:14:34+08:00</updated>
    <id>http://johnfeng.github.io/blog/2015/02/27/android-webview-issue-service-not-registered-android-dot-speech-dot-tts-dot-texttospeech</id>
    <content type="html"><![CDATA[<h2 id="problem">Problem</h2>

<p>Noticed a weird crash related with Android TTS, which I didn&rsquo;t wish to use, when I tried to initial or destroy a webview loaded from XML file.
Here is the console output:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">```Java
java.lang.IllegalArgumentException: Service not registered: android.speech.tts.TextToSpeech$Connection@41519670
   at android.app.LoadedApk.forgetServiceDispatcher(LoadedApk.java:937)
   at android.app.ContextImpl.unbindService(ContextImpl.java:1521)
   at android.content.ContextWrapper.unbindService(ContextWrapper.java:490)
   at android.speech.tts.TextToSpeech$Connection.disconnect(TextToSpeech.java:1321)
   at android.speech.tts.TextToSpeech$1.run(TextToSpeech.java:661)
   at android.speech.tts.TextToSpeech$1.run(TextToSpeech.java:656)
   at android.speech.tts.TextToSpeech$Connection.runAction(TextToSpeech.java:1340)
   at android.speech.tts.TextToSpeech.runAction(TextToSpeech.java:570)
   at android.speech.tts.TextToSpeech.runActionNoReconnect(TextToSpeech.java:557)
   at android.speech.tts.TextToSpeech.shutdown(TextToSpeech.java:656)
   at android.webkit.AccessibilityInjector$TextToSpeechWrapper.shutdown(AccessibilityInjector.java:748)
   at android.webkit.AccessibilityInjector.destroy(AccessibilityInjector.java:187)
   at android.webkit.WebViewClassic.destroyJava(WebViewClassic.java:2618)
   at android.webkit.WebViewClassic.destroy(WebViewClassic.java:2601)
   at android.webkit.WebView.destroy(WebView.java:665)
   at com.douban.dongxi.app.BrowserPurchaseActvitiy$5.run(BrowserPurchaseActvitiy.java:197)
   at android.os.Handler.handleCallback(Handler.java:725)
   at android.os.Handler.dispatchMessage(Handler.java:92)
   at android.os.Looper.loop(Looper.java:137)
   at android.app.ActivityThread.main(ActivityThread.java:5105)
   at java.lang.reflect.Method.invokeNative(Method.java)
   at java.lang.reflect.Method.invoke(Method.java:511)
   at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:793)
   at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:560)
   at dalvik.system.NativeStart.main(NativeStart.java)
   ```
</code></pre></div>
<h4 id="and-the-output-from-crashlytics.">And the output from <strong><a href="http://crashes.to/s/539a8babf82">CrashLytics</a></strong>.</h4>

<p><img src="https://github.com/JohnFeng/johnfeng.github.io/blob/source/source/images/CrashLytics%202015-02-27%20at%2012.22.23.png?raw=true" alt="Crash Pie Chart">
<em>Notice that most crashes happened third-party roms like :MEIZU. Had they changed the webview core?</em></p>

<hr>

<h2 id="fix">Fix</h2>

<ol>
<li>One Method from <a href="http://stackoverflow.com/questions/27740935/service-not-registered-android-speech-tts-texttospeech">stackoverflow</a></li>
</ol>

<blockquote>
<p>Have to move all webview from the <strong>xml</strong> file and have added them <strong>dynamically</strong> and passing application context.</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">WebView webView = new WebView(getApplicationContext());
</code></pre></div>
<ol>
<li><p>Use following code in OnDestory() method.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@Override
protected void onDestroy() {
     clearHistory();
     long timeout = ViewConfiguration.getZoomControlsTimeout();
     new Timer().schedule(new TimerTask() {
             @Override
              public void run() {
                    destroyWebView(mWebView);
              }
      }, timeout);
}

void clearHistory() {
if (mWebView != null) {
    runOnUiThread(new Runnable() {
        @Override
        public void run() {
            mWebView.clearHistory();
        }
    });
}  

private void destroyWebView(final WebView webView) {
    if (webView != null) {
    try {
        mWebViewContainer.removeView(webView);

        if (webView != null) {
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    webView.stopLoading();
                    webView.removeAllViews();
                    webView.clearCache(true);
                    webView.destroyDrawingCache();
                    webView.destroy();
                }
            });
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre></div></li>
</ol>

<p>Two things should be noticed :
  1. all operations related with Webview should be on the <strong>UIThread</strong>
  2. webview-destroy operations should happen after removed it from the <strong>container</strong> view.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Weibo Android SDK 3.0.1 Load libweibosdkcore.so Crash]]></title>
    <link href="http://johnfeng.github.io/blog/2015/02/25/weibo-android-sdk-3-dot-0-1-load-so-crash/"/>
    <updated>2015-02-25T16:51:47+08:00</updated>
    <id>http://johnfeng.github.io/blog/2015/02/25/weibo-android-sdk-3-dot-0-1-load-so-crash</id>
    <content type="html"><![CDATA[<hr>

<h2 id="question">Question</h2>

<p>I was trying to update my App&rsquo;s Weibo-SDK version from 2.x to 3.0.1 <em>(in order to fix the SSO crash when authorizing apps without Weibo&rsquo;s client, happens on **Lollipop</em><em>)</em>, building process failed with log : Couldn&rsquo;t load sdk from loader dalvik &hellip; <strong>libweibosdkcore.so</strong> file.</p>

<p>After pasting the &ldquo;libweibosdkcore.so&rdquo; file into &ldquo;libs/armeabi-v7a/&rdquo; folder, gradle still could not pass the building process.</p>

<h2 id="fix">Fix</h2>

<p>Add the following codes into the &ldquo;build.gradle&rdquo; file, inside of  the &ldquo;android&rdquo; block:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java">    <span class="c1">//noinspection all</span>
    <span class="n">task</span> <span class="nf">copyNativeLibs</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Copy</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// third party lib so                </span>
        <span class="n">from</span><span class="o">(</span><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">projectDir</span><span class="o">,</span> <span class="err">&#39;</span><span class="n">libs</span><span class="err">&#39;</span><span class="o">))</span> <span class="o">{</span> <span class="n">include</span> <span class="err">&#39;</span><span class="n">armeabi</span><span class="o">/*.</span><span class="na">so</span><span class="sc">&#39;,&#39;</span><span class="n">armeabi</span><span class="o">-</span><span class="n">v7a</span><span class="o">/*.</span><span class="na">so</span><span class="err">&#39;</span> <span class="o">}</span>        
        <span class="n">into</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">buildDir</span><span class="o">,</span> <span class="err">&#39;</span><span class="kd">native</span><span class="o">-</span><span class="n">libs</span><span class="err">&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">tasks</span><span class="o">.</span><span class="na">withType</span><span class="o">(</span><span class="n">JavaCompile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">compileTask</span> <span class="o">-&gt;</span>
            <span class="c1">//noinspection all</span>
            <span class="n">compileTask</span><span class="o">.</span><span class="na">dependsOn</span> <span class="n">copyNativeLibs</span>
    <span class="o">}</span>

    <span class="c1">//noinspection all</span>
    <span class="n">tasks</span><span class="o">.</span><span class="na">withType</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">build</span><span class="o">.</span><span class="na">gradle</span><span class="o">.</span><span class="na">tasks</span><span class="o">.</span><span class="na">PackageApplication</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pkgTask</span> <span class="o">-&gt;</span>
            <span class="n">pkgTask</span><span class="o">.</span><span class="na">jniFolders</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HashSet</span><span class="o">()</span>
            <span class="n">pkgTask</span><span class="o">.</span><span class="na">jniFolders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">buildDir</span><span class="o">,</span> <span class="err">&#39;</span><span class="kd">native</span><span class="o">-</span><span class="n">libs</span><span class="err">&#39;</span><span class="o">))</span>
    <span class="o">}</span>
</code></pre></div>
<p>Problem Solved.</p>

<p>From &lt;<a href="http://blog.sina.com.cn/s/blog_92814aa60102vhv1.html">镕羽&rsquo;s Blog</a>&gt;</p>
]]></content>
  </entry>
  
</feed>
